<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .time-slot { transition: all 0.2s ease-in-out; }
        .time-slot.reserved { background-color: #4b5563; color: #d1d5db; }
        .time-slot:not(.reserved):hover { background-color: #374151; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div id="login-section" class="flex items-center justify-center min-h-screen">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-center text-red-400">관리자 로그인</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block mb-2 text-sm font-medium">사용자 이름</label>
                    <input type="text" id="username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block mb-2 text-sm font-medium">비밀번호</label>
                    <input type="password" id="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required>
                </div>
                <button type="submit" class="w-full text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">로그인</button>
                <p id="login-error" class="text-yellow-400 text-sm mt-4 text-center h-5"></p>
            </form>
        </div>
    </div>

    <div id="app-section" class="hidden container mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <h1 class="text-3xl font-bold text-red-400 mb-4 md:mb-0">예약 관리 시스템</h1>
            <div class="flex items-center">
                <span id="current-user-display" class="font-semibold"></span>님
                <button id="logout-button" class="ml-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">로그아웃</button>
            </div>
        </header>

        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-yellow-300">예약 초기화 스케줄링</h2>
                <div class="flex items-center gap-4">
                    <input type="datetime-local" id="schedule-datetime" class="bg-gray-700 border border-gray-600 rounded-lg p-2 text-white [color-scheme:dark] w-full">
                    <button id="schedule-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex-shrink-0">설정</button>
                </div>
                <p class="mt-2 text-sm text-gray-400">현재 예약 오픈 시간: <span id="current-schedule-display" class="font-mono"></span></p>
                <p id="schedule-status" class="mt-2 text-green-400 h-5"></p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-yellow-300">사용자 목록(.csv) 업로드</h2>
                <div class="flex items-center gap-4">
                    <input type="file" id="user-file-input" accept=".csv" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer">
                    <button id="upload-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex-shrink-0">업로드</button>
                </div>
                <p class="mt-2 text-sm text-gray-400">파일 형식: username,password,allowed_hours,role</p>
                <p id="upload-status" class="mt-2 text-green-400 h-5"></p>
            </div>
        </div>

        <div id="timetable-grid" class="grid grid-cols-8 gap-1 text-center text-sm">
            </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 상수 및 DOM 요소 ---
    const API_BASE_URL = "http://127.0.0.1:8000";
    const WS_URL = "ws://127.0.0.1:8000/ws";

    const loginSection = document.getElementById('login-section'),
        appSection = document.getElementById('app-section'),
        loginForm = document.getElementById('login-form'),
        loginError = document.getElementById('login-error'),
        timetableGrid = document.getElementById('timetable-grid'),
        currentUserDisplay = document.getElementById('current-user-display'),
        logoutButton = document.getElementById('logout-button'),
        scheduleDatetimeInput = document.getElementById('schedule-datetime'),
        scheduleButton = document.getElementById('schedule-button'),
        currentScheduleDisplay = document.getElementById('current-schedule-display'),
        scheduleStatus = document.getElementById('schedule-status'),
        userFileInput = document.getElementById('user-file-input'),
        uploadButton = document.getElementById('upload-button'),
        uploadStatus = document.getElementById('upload-status');

    let state = { token: null, currentUser: null, reservations: [], ws: null };

    // --- API 호출 ---
    async function apiCall(endpoint, method = 'GET', body = null) {
        const headers = { 'Authorization': `Bearer ${state.token}` };
        const options = { method, headers };
        if (body) {
            headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || 'API 요청 실패');
        }
        return response.status === 204 ? null : response.json();
    }

    // --- 렌더링 ---
    function renderTimetable() {
        timetableGrid.innerHTML = '';
        const days = ['시간', '월', '화', '수', '목', '금', '토', '일'];
        const reservedMap = new Map(state.reservations.map(r => [`${r.day}-${r.time_index}`, r.username]));

        days.forEach(day => timetableGrid.insertAdjacentHTML('beforeend', `<div class="font-bold bg-gray-700 p-2 rounded-t-lg">${day}</div>`));

        for (let i = 0; i < 17; i++) {
            const timeLabel = `${String(i + 7).padStart(2, '0')}:00`;
            timetableGrid.insertAdjacentHTML('beforeend', `<div class="font-bold bg-gray-700 p-2">${timeLabel}</div>`);

            for (let j = 1; j < days.length; j++) {
                const day = days[j];
                const username = reservedMap.get(`${day}-${i}`);
                const isReserved = !!username;
                const slotClass = `time-slot p-2 rounded-lg cursor-pointer ${isReserved ? 'reserved' : 'bg-gray-800'}`;
                const slotHTML = `<div class="${slotClass}" data-day="${day}" data-time-index="${i}">${username || '&nbsp;'}</div>`;
                timetableGrid.insertAdjacentHTML('beforeend', slotHTML);
            }
        }
        timetableGrid.querySelectorAll('.time-slot').forEach(slot => slot.addEventListener('click', handleSlotClick));
    }

    // --- 이벤트 핸들러 ---
    async function handleSlotClick(event) {
        const slot = event.target;
        const { day, timeIndex } = slot.dataset;
        const time_index = parseInt(timeIndex);
        const currentUsername = slot.textContent.trim();

        const newUsername = prompt(
            `[${day} ${String(time_index + 7).padStart(2, '0')}:00] 예약 관리\n현재 예약자: ${currentUsername || '없음'}\n\n수정할 이름을 입력하세요 (비워두면 삭제됩니다).`,
            currentUsername
        );

        if (newUsername === null) return; // 사용자가 '취소'를 누름

        try {
            if (newUsername.trim() === '') {
                if (!currentUsername) return; // 빈 슬롯 삭제 시도 방지
                await apiCall('/admin/reservation', 'DELETE', { day, time_index });
            } else {
                await apiCall('/admin/reservation', 'POST', { day, time_index, username: newUsername.trim() });
            }
        } catch (error) {
            alert(`오류: ${error.message}`);
        }
    }

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        try {
            const response = await fetch(`${API_BASE_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username.value, password: password.value }),
            });
            if (!response.ok) throw new Error('로그인 실패');

            const data = await response.json();
            state.token = data.access_token;
            state.currentUser = username.value;

            localStorage.setItem('adminAuthToken', state.token);
            localStorage.setItem('adminUser', state.currentUser);
            await initializeApp();
        } catch (error) {
            loginError.textContent = '아이디 또는 비밀번호를 확인하세요.';
        }
    });

    logoutButton.addEventListener('click', () => {
        state = { token: null, currentUser: null, reservations: [], ws: null };
        localStorage.clear();
        if (state.ws) {
            state.ws.onclose = null; // 재연결 방지
            state.ws.close();
        }
        appSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
    });

    scheduleButton.addEventListener('click', async () => {
        const dtValue = scheduleDatetimeInput.value;
        if (!dtValue) {
            setStatusMessage('날짜와 시간을 선택하세요.', 'yellow', scheduleStatus);
            return;
        }
        try {
            const datetimeWithSeconds = dtValue + ':00';
            const timezoneOffset = getOffsetString(new Date());
            const finalIsoString = datetimeWithSeconds + timezoneOffset;

            const result = await apiCall('/admin/schedule', 'POST', { open_datetime: finalIsoString });
            currentScheduleDisplay.textContent = new Date(result.open_time).toLocaleString();
            setStatusMessage(`성공! 예약이 ${new Date(result.reset_time).toLocaleString()}에 초기화됩니다.`, 'green', scheduleStatus);
        } catch (error) {
            setStatusMessage(`스케줄 설정 실패: ${error.message}`, 'red', scheduleStatus);
        }
    });

    uploadButton.addEventListener('click', async () => {
        const file = userFileInput.files[0];
        if (!file) {
            setStatusMessage('먼저 CSV 파일을 선택하세요.', 'yellow', uploadStatus);
            return;
        }
        const formData = new FormData();
        formData.append("file", file);
        setStatusMessage('업로드 중...', 'blue', uploadStatus);
        try {
            const response = await fetch(`${API_BASE_URL}/admin/upload/users`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${state.token}` },
                body: formData,
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail);
            setStatusMessage(result.message, 'green', uploadStatus);
            userFileInput.value = '';
        } catch (error) {
            setStatusMessage(`업로드 실패: ${error.message}`, 'red', uploadStatus);
        }
    });

    // --- 웹소켓 ---
    function connectWebSocket() {
        if (state.ws && state.ws.readyState === WebSocket.OPEN) return;
        state.ws = new WebSocket(WS_URL);
        state.ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            let needsRender = false;
            if (msg.type === 'RESERVATION_UPDATE') {
                msg.data.forEach(newItem => {
                    const index = state.reservations.findIndex(r => r.day === newItem.day && r.time_index === newItem.time_index);
                    if (index > -1) state.reservations[index] = newItem;
                    else state.reservations.push(newItem);
                });
                needsRender = true;
            } else if (msg.type === 'RESERVATION_DELETE') {
                state.reservations = state.reservations.filter(r => !(r.day === msg.data.day && r.time_index === msg.data.time_index));
                needsRender = true;
            } else if (msg.type === 'RESERVATION_RESET') {
                state.reservations = [];
                alert('스케줄에 따라 모든 예약이 초기화되었습니다.');
                needsRender = true;
            }
            if (needsRender) renderTimetable();
        };
        state.ws.onclose = () => {
            setTimeout(() => { if (state.token) connectWebSocket(); }, 5000);
        };
    }

    // --- 유틸리티 및 초기화 ---
    function getOffsetString(date) {
        const offset = -date.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const hours = Math.floor(Math.abs(offset) / 60);
        const minutes = Math.abs(offset) % 60;
        return `${sign}${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    function setStatusMessage(msg, color, element) {
        element.textContent = msg;
        element.className = `mt-2 h-5 text-${color}-400`;
        setTimeout(() => { if (element.textContent === msg) element.textContent = ''; }, 5000);
    }

    async function initializeApp() {
        try {
            const scheduleInfo = await apiCall('/admin/schedule');
            currentScheduleDisplay.textContent = new Date(scheduleInfo.open_datetime).toLocaleString();
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            currentUserDisplay.textContent = state.currentUser;
            state.reservations = await apiCall('/reservations');
            renderTimetable();
            connectWebSocket();
        } catch (error) {
            logoutButton.click();
            loginError.textContent = "관리자 권한이 없거나 세션이 만료되었습니다.";
        }
    }

    // 페이지 로드 시 자동 로그인 시도
    const token = localStorage.getItem('adminAuthToken');
    const user = localStorage.getItem('adminUser');
    if (token && user) {
        state.token = token;
        state.currentUser = user;
        initializeApp();
    }
});
</script>
</body>
</html>