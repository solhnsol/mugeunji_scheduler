<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시간표 예약 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .time-slot {
            transition: all 0.2s ease-in-out;
        }
        .time-slot.selected {
            background-color: #3b82f6 !important; /* blue-500 */
            color: white;
            transform: scale(1.05);
        }
        .time-slot.reserved {
            background-color: #4b5563; /* gray-600 */
            color: #d1d5db; /* gray-300 */
            cursor: not-allowed;
        }
        .time-slot.my-reservation {
            background-color: #16a34a; /* green-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <div id="login-section" class="flex items-center justify-center min-h-screen">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-center text-blue-400">로그인</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block mb-2 text-sm font-medium text-gray-300">사용자 이름</label>
                    <input type="text" id="username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block mb-2 text-sm font-medium text-gray-300">비밀번호</label>
                    <input type="password" id="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                    로그인
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center h-5"></p>
            </form>
        </div>
    </div>

    <div id="app-section" class="hidden container mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <h1 class="text-3xl font-bold text-blue-400 mb-4 md:mb-0">시간표 예약</h1>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="font-semibold"><span id="current-user-display"></span>님</p>
                    <p class="text-sm text-gray-400">예약 가능: <span id="allowed-hours-display"></span>시간</p>
                </div>
                <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    로그아웃
                </button>
            </div>
        </header>

        <div id="timetable-grid" class="grid grid-cols-8 gap-1 text-center text-xs md:text-sm">
            </div>

        <div class="text-center mt-6">
            <p id="reserve-status" class="h-6 text-yellow-400 mb-2"></p>
            <div id="countdown-wrapper" class="text-center mb-4">
                <p class="text-lg">예약 오픈까지 남은 시간</p>
                <p id="countdown-display" class="text-2xl font-bold text-yellow-400">서버 시간 확인 중...</p>
            </div>
            <button id="reserve-button" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-transform duration-200 hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                <span id="selected-count">0</span>개 시간 선택됨 - 예약하기
            </button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE_URL = "http://127.0.0.1:8000";
    const WS_URL = "ws://127.0.0.1:8000/ws";

    // --- DOM 요소 ---
    const loginSection = document.getElementById('login-section'), appSection = document.getElementById('app-section'),
        loginForm = document.getElementById('login-form'), loginError = document.getElementById('login-error'),
        timetableGrid = document.getElementById('timetable-grid'), reserveButton = document.getElementById('reserve-button'),
        selectedCountSpan = document.getElementById('selected-count'), reserveStatus = document.getElementById('reserve-status'),
        currentUserDisplay = document.getElementById('current-user-display'), allowedHoursDisplay = document.getElementById('allowed-hours-display'),
        logoutButton = document.getElementById('logout-button'), countdownWrapper = document.getElementById('countdown-wrapper'),
        countdownDisplay = document.getElementById('countdown-display');

    // --- 상태 관리 ---
    let state = {
        token: null, currentUser: null, allowedHours: 0,
        reservations: [], selectedSlots: [], ws: null,
        reservationOpenTime: null, // 서버에서 받아올 실제 예약 시간
        isReservationOpen: false,
        countdownInterval: null
    };

    // --- API 호출 함수 ---
    async function apiLogin(username, password) {
        const response = await fetch(`${API_BASE_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
        });
        if (!response.ok) throw new Error('사용자 이름 또는 비밀번호가 잘못되었습니다.');
        return response.json();
    }
    async function fetchReservations() {
        const response = await fetch(`${API_BASE_URL}/reservations`);
        state.reservations = await response.json();
        renderTimetable();
    }
    async function postReservations() {
        reserveStatus.textContent = '예약 처리 중...';
        try {
            const response = await fetch(`${API_BASE_URL}/reservations`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.token}`,
                },
                body: JSON.stringify(state.selectedSlots),
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '예약에 실패했습니다.');
            }
            reserveStatus.textContent = '예약이 성공적으로 완료되었습니다!';
            state.selectedSlots = [];
        } catch (error) {
            reserveStatus.textContent = `오류: ${error.message}`;
        } finally {
            updateReserveButton();
            setTimeout(() => { reserveStatus.textContent = ''; }, 3000);
        }
    }

    // --- 렌더링 함수 ---
    function renderTimetable() {
        timetableGrid.innerHTML = '';
        const days = ['시간', '월', '화', '수', '목', '금', '토', '일'];
        const reservedMap = new Map();
        state.reservations.forEach(r => reservedMap.set(`${r.day}-${r.time_index}`, r.username));

        days.forEach(day => timetableGrid.insertAdjacentHTML('beforeend', `<div class="font-bold bg-gray-700 p-2 rounded-t-lg">${day}</div>`));

        for (let i = 0; i < 17; i++) {
            const timeLabel = `${String(i + 7).padStart(2, '0')}:00`;
            timetableGrid.insertAdjacentHTML('beforeend', `<div class="font-bold bg-gray-700 p-2">${timeLabel}</div>`);

            for (let j = 1; j < days.length; j++) {
                const day = days[j];
                const slot = document.createElement('div');
                slot.id = `slot-${day}-${i}`;
                slot.className = 'time-slot bg-gray-800 p-2 rounded-lg cursor-pointer hover:bg-gray-600';
                slot.dataset.day = day;
                slot.dataset.timeIndex = i;

                const reservationUser = reservedMap.get(`${day}-${i}`);
                if (reservationUser) {
                    slot.textContent = reservationUser;
                    slot.classList.add('reserved');
                    if (reservationUser === state.currentUser) {
                        slot.classList.add('my-reservation');
                    }
                } else {
                    slot.addEventListener('click', handleSlotClick);
                }
                const isSelected = state.selectedSlots.some(s => s.day === day && s.time_index === i);
                if (isSelected) slot.classList.add('selected');
                timetableGrid.appendChild(slot);
            }
        }
        updateMyReservationCount();
    }
    function validateSelection(selectedSlots) {
        if (selectedSlots.length === 0) return { isValid: true, message: '' };
        const groupedByDay = selectedSlots.reduce((acc, slot) => {
            (acc[slot.day] = acc[slot.day] || []).push(slot.time_index);
            return acc;
        }, {});
        for (const day in groupedByDay) {
            const sortedIndices = groupedByDay[day].sort((a, b) => a - b);
            for (let i = 1; i < sortedIndices.length; i++) {
                if (sortedIndices[i] - sortedIndices[i - 1] === 2) {
                    return { isValid: false, message: `[${day}] 요일의 예약은 연속되거나 최소 2시간 이상 간격을 두어야 합니다.` };
                }
            }
        }
        return { isValid: true, message: '' };
    }
    function updateReserveButton() {
        if (!state.isReservationOpen) {
            reserveButton.disabled = true;
            return;
        }
        const count = state.selectedSlots.length;
        selectedCountSpan.textContent = count;
        const validation = validateSelection(state.selectedSlots);
        if (!validation.isValid) {
            reserveButton.disabled = true;
            reserveStatus.textContent = validation.message;
            return;
        }
        const myReservations = state.reservations.filter(r => r.username === state.currentUser).length;
        const totalSelected = myReservations + count;
        if (totalSelected === state.allowedHours && count > 0) {
            reserveButton.disabled = false;
            reserveStatus.textContent = '모든 시간을 선택했습니다. 예약할 수 있습니다.';
        } else if (totalSelected > state.allowedHours) {
            reserveButton.disabled = true;
            reserveStatus.textContent = `예약 가능 시간을 ${totalSelected - state.allowedHours}시간 초과했습니다.`;
        } else {
            reserveButton.disabled = true;
            const remaining = state.allowedHours - totalSelected;
            reserveStatus.textContent = remaining > 0 ? `${remaining}시간을 더 선택해야 합니다.` : '';
        }
    }
    function updateMyReservationCount() {
        if (!state.token) return;
        const myReservations = state.reservations.filter(r => r.username === state.currentUser).length;
        allowedHoursDisplay.textContent = `${state.allowedHours - myReservations}`;
    }
    function resetStateForLogout() {
        state.token = null; state.currentUser = null; state.allowedHours = 0;
        state.reservations = []; state.selectedSlots = [];
        if (state.ws) {
            state.ws.onclose = null;
            state.ws.close();
            state.ws = null;
        }
    }

    // --- 이벤트 핸들러 ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        const usernameInput = document.getElementById('username').value;
        const passwordInput = document.getElementById('password').value;
        try {
            const data = await apiLogin(usernameInput, passwordInput);
            state.token = data.access_token;
            state.currentUser = usernameInput;
            state.allowedHours = data.allowed_hours;
            localStorage.setItem('authToken', state.token);
            localStorage.setItem('currentUser', state.currentUser);
            localStorage.setItem('allowedHours', state.allowedHours);
            initializeAppUI();
        } catch (error) {
            loginError.textContent = error.message;
        }
    });
    logoutButton.addEventListener('click', () => {
        resetStateForLogout();
        localStorage.clear();
        appSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
    });
    function handleSlotClick(event) {
        const slot = event.target;
        const day = slot.dataset.day;
        const timeIndex = parseInt(slot.dataset.timeIndex);
        const myReservations = state.reservations.filter(r => r.username === state.currentUser).length;
        const selectedIndex = state.selectedSlots.findIndex(s => s.day === day && s.time_index === timeIndex);
        if (selectedIndex > -1) {
            state.selectedSlots.splice(selectedIndex, 1);
            slot.classList.remove('selected');
        } else {
            if (myReservations + state.selectedSlots.length >= state.allowedHours) {
                reserveStatus.textContent = '더 이상 시간을 선택할 수 없습니다.';
                setTimeout(() => { if (reserveStatus.textContent === '더 이상 시간을 선택할 수 없습니다.') reserveStatus.textContent = ''; }, 2000);
                return;
            }
            state.selectedSlots.push({ day, time_index: timeIndex });
            slot.classList.add('selected');
        }
        updateReserveButton();
    }
    reserveButton.addEventListener('click', postReservations);

    // --- 웹소켓 ---
    function connectWebSocket() {
        if (state.ws && state.ws.readyState === WebSocket.OPEN) return;
        state.ws = new WebSocket(WS_URL);
        state.ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            let needsRender = false;
            if (msg.type === 'RESERVATION_UPDATE') {
                msg.data.forEach(newItem => {
                    const index = state.reservations.findIndex(r => r.day === newItem.day && r.time_index === newItem.time_index);
                    if (index > -1) state.reservations[index] = newItem;
                    else state.reservations.push(newItem);
                });
                needsRender = true;
            } else if (msg.type === 'RESERVATION_DELETE') {
                state.reservations = state.reservations.filter(r => !(r.day === msg.data.day && r.time_index === msg.data.time_index));
                needsRender = true;
            } else if (msg.type === 'RESERVATION_RESET') {
                alert('스케줄에 따라 모든 예약이 초기화되었습니다. 페이지를 새로고침합니다.');
                window.location.reload();
                return;
            }
            if (needsRender) {
                state.selectedSlots = state.selectedSlots.filter(s => {
                    return !state.reservations.some(r => r.day === s.day && r.time_index === s.time_index);
                });
                renderTimetable();
                updateReserveButton();
            }
        };
        state.ws.onclose = () => { if (state.token) setTimeout(connectWebSocket, 5000); };
    }

    // --- 앱 초기화 로직 ---
    function startCountdown() {
        if (!state.reservationOpenTime) return;
        reserveButton.classList.add('hidden');
        countdownWrapper.classList.remove('hidden');
        state.countdownInterval = setInterval(() => {
            const now = new Date();
            const distance = state.reservationOpenTime - now;
            if (distance < 0) {
                clearInterval(state.countdownInterval);
                state.isReservationOpen = true;
                countdownWrapper.classList.add('hidden');
                reserveButton.classList.remove('hidden');
                if (state.token) updateReserveButton();
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            let countdownText = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (days > 0) countdownText = `${days}일 ${countdownText}`;
            countdownDisplay.textContent = countdownText;
        }, 1000);
    }
    function initializeAppUI() {
        loginSection.classList.add('hidden');
        appSection.classList.remove('hidden');
        currentUserDisplay.textContent = state.currentUser;
        fetchReservations();
        connectWebSocket();
    }
    async function initPage() {
        try {
            const response = await fetch(`${API_BASE_URL}/schedule/open-time`);
            if (!response.ok) throw new Error('Server not ready');
            const data = await response.json();
            state.reservationOpenTime = new Date(data.open_datetime);
        } catch (error) {
            console.error("Failed to get open time:", error);
            countdownDisplay.textContent = "서버 연결 오류";
            return;
        }
        startCountdown();
        const token = localStorage.getItem('authToken'), user = localStorage.getItem('currentUser'), hours = localStorage.getItem('allowedHours');
        if (token && user && hours) {
            state.token = token;
            state.currentUser = user;
            state.allowedHours = parseInt(hours);
            initializeAppUI();
        }
    }
    initPage();
});
</script>
</body>
</html>